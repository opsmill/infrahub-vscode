---
# yamllint disable rule:truthy rule:line-length
name: "Claude Implement"

on:
  issue_comment:
    types: [created]

jobs:
  implement:
    if: >-
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    concurrency:
      group: claude-implement-${{ github.event.issue.number }}
      cancel-in-progress: false
    steps:
      - name: Check commenter permissions
        id: check-permission
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PERMISSION=$(gh api "repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission" \
            --jq '.permission')
          echo "permission=$PERMISSION" >> "$GITHUB_OUTPUT"

          if [[ "$PERMISSION" != "admin" && "$PERMISSION" != "write" && "$PERMISSION" != "maintain" ]]; then
            echo "::error::User ${{ github.event.comment.user.login }} does not have write access (has: $PERMISSION)"
            exit 1
          fi
          echo "User ${{ github.event.comment.user.login }} has $PERMISSION access - authorized"

      - name: React to comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content='+1' --silent

      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Fetch issue and comments
        id: issue-context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}

          # Fetch issue body
          ISSUE_BODY=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}" --jq '.body')

          # Fetch all comments
          COMMENTS=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            --paginate --jq '.[] | "---\n**@\(.user.login):**\n\(.body)\n"')

          # Write to files for Claude to read
          echo "$ISSUE_BODY" > /tmp/issue-body.md
          echo "$COMMENTS" > /tmp/issue-comments.md

      - name: Implement with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: >-
            --model claude-sonnet-4-20250514
            --max-turns 50
            --allowedTools "Read,Write,Edit,Grep,Glob,Bash(npm run compile),Bash(npm run lint),Bash(git:*),Bash(gh:*)"
          prompt: |
            You are implementing changes for issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            First, read the project documentation:
            - CLAUDE.md

            Then read the issue context:
            - /tmp/issue-body.md (the issue description)
            - /tmp/issue-comments.md (all comments, including the implementation plan)

            Find the implementation plan or bug analysis in the comments (posted by github-actions bot).
            Follow that plan to implement the changes.

            After implementing:
            1. Run `npm run compile` to verify the build succeeds
            2. Run `npm run lint` to verify no lint errors
            3. Fix any issues found

            Then create a branch and PR:
            1. Create a branch named `claude/issue-${{ github.event.issue.number }}`
            2. Commit all changes with a descriptive message
            3. Push the branch
            4. Create a PR that references issue #${{ github.event.issue.number }} using:
               gh pr create --title "<descriptive title>" \
                 --body "Closes #${{ github.event.issue.number }}

               ## Changes
               <summary of changes>

               ## Generated by Claude
               Implemented from the plan in issue #${{ github.event.issue.number }}"

            Important:
            - Follow the coding standards in CLAUDE.md
            - Add disposables to context.subscriptions
            - Include timeout handling for API calls
            - Do not commit .env files or hardcoded tokens
