---
# yamllint disable rule:truthy rule:line-length
name: "Issue Plan"

on:
  issues:
    types: [labeled]

jobs:
  feature-plan:
    if: >-
      github.event.label.name == 'type/feature' &&
      !contains(github.event.issue.labels.*.name, 'state/planned')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
    concurrency:
      group: issue-plan-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Generate feature spec and plan
        id: plan
        uses: anthropics/claude-code-action@v1
        with:
          model: claude-sonnet-4-20250514
          max_turns: 15
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a technical planning assistant for the Infrahub VSCode Extension.

            Read the following project files to understand the codebase:
            - CLAUDE.md (project overview)
            - dev/knowledge/architecture.md (architecture details)
            - dev/specs/template.md (spec template format)

            Then analyze this feature request:

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            Generate a specification and implementation plan using the spec template format
            from dev/specs/template.md. Your output should be a single markdown document with:

            1. **Specification** following the template format (Summary, Motivation, Design, Tasks, Open Questions)
            2. **Implementation Plan** with ordered steps, each listing:
               - Files to create or modify
               - What changes to make
               - Dependencies on other steps

            Be specific about file paths and code changes. Reference existing patterns in the codebase.

            Output ONLY the markdown document, no preamble.

      - name: Post plan as comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PLAN: ${{ steps.plan.outputs.result }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}

          # Use gh api to post comment with proper escaping
          ESCAPED_PLAN=$(echo "$PLAN" | jq -Rs .)
          jq -n --argjson body "$ESCAPED_PLAN" \
            '{"body": ("## Feature Specification & Implementation Plan\n\n> Generated by Claude from issue description. Review and refine before implementing.\n\n" + $body + "\n\n---\n*To implement this plan, a maintainer can comment `@claude implement` on this issue.*")}' | \
            gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" --input -

      - name: Update labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          gh label create "state/planned" --force 2>/dev/null || true
          gh issue edit "$ISSUE_NUMBER" --add-label "state/planned"
          gh issue edit "$ISSUE_NUMBER" --remove-label "state/need-triage" 2>/dev/null || true

  bug-analysis:
    if: >-
      github.event.label.name == 'type/bug' &&
      !contains(github.event.issue.labels.*.name, 'state/planned')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
    concurrency:
      group: issue-plan-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Analyze bug
        id: analysis
        uses: anthropics/claude-code-action@v1
        with:
          model: claude-sonnet-4-20250514
          max_turns: 15
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a bug analysis assistant for the Infrahub VSCode Extension.

            Read the following project files to understand the codebase:
            - CLAUDE.md (project overview)
            - dev/knowledge/architecture.md (architecture details)
            - dev/prompts/bug-analysis.md (analysis framework)

            Then analyze this bug report:

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            Follow the bug analysis framework from dev/prompts/bug-analysis.md:

            1. **Locate the Code Path**: Trace from the reported behavior to the relevant
               source files. Identify which commands, providers, or handlers are involved.

            2. **Identify Root Cause**: Determine the most likely cause category:
               - API communication failure
               - YAML parsing error
               - VSCode API misuse
               - Configuration issue
               - Other

            3. **Recommended Fix**: Provide specific code changes with file paths and
               line-level guidance.

            4. **Regression Test**: Describe a test that would catch this bug.

            Output the analysis in this format:

            ## Summary
            [One sentence]

            ## Code Path
            [Trace from entry point to the bug location]

            ## Root Cause
            [Explanation with evidence from the code]

            ## Recommended Fix
            [Specific code changes with file paths]

            ## Regression Test
            [Test description and location]

            ## Implementation Plan
            [Ordered steps to fix this bug]

            Output ONLY the markdown, no preamble.

      - name: Post analysis as comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANALYSIS: ${{ steps.analysis.outputs.result }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}

          ESCAPED_ANALYSIS=$(echo "$ANALYSIS" | jq -Rs .)
          jq -n --argjson body "$ESCAPED_ANALYSIS" \
            '{"body": ("## Bug Analysis\n\n> Generated by Claude from bug report. Review before implementing.\n\n" + $body + "\n\n---\n*To implement the fix, a maintainer can comment `@claude implement` on this issue.*")}' | \
            gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" --input -

      - name: Update labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          gh label create "state/planned" --force 2>/dev/null || true
          gh issue edit "$ISSUE_NUMBER" --add-label "state/planned"
          gh issue edit "$ISSUE_NUMBER" --remove-label "state/need-triage" 2>/dev/null || true
