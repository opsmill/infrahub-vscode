---
# yamllint disable rule:truthy rule:line-length
name: "Issue Plan"

on:
  issues:
    types: [labeled]

jobs:
  feature-plan:
    if: >-
      github.event.label.name == 'type/feature' &&
      !contains(github.event.issue.labels.*.name, 'state/planned')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    concurrency:
      group: issue-plan-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Generate feature spec and plan
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --max-turns 15
            --allowedTools "Read,Grep,Glob,Bash(gh issue:*),Bash(gh label:*)"
          prompt: |
            You are a technical planning assistant for the Infrahub VSCode Extension.

            Read the following project files to understand the codebase:
            - CLAUDE.md (project overview and coding standards)

            Then analyze this feature request:

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            Generate a specification and implementation plan with:

            1. **Specification** (Summary, Motivation, Design, Tasks, Open Questions)
            2. **Implementation Plan** with ordered steps, each listing:
               - Files to create or modify
               - What changes to make
               - Dependencies on other steps

            Be specific about file paths and code changes. Reference existing patterns in the codebase.

            After generating the plan, post it as a comment on issue #${{ github.event.issue.number }}:
            Write the plan to a temp file, then run:
            gh issue comment ${{ github.event.issue.number }} --body-file /tmp/plan-comment.md

            The comment should be formatted as:
            ## Feature Specification & Implementation Plan
            > Generated by Claude from issue description. Review and refine before implementing.
            <your plan>
            ---
            *To implement this plan, a maintainer can comment `@claude implement` on this issue.*

            Then update the labels:
            gh label create "state/planned" --force
            gh issue edit ${{ github.event.issue.number }} --add-label "state/planned"
            gh issue edit ${{ github.event.issue.number }} --remove-label "state/need-triage" || true

  bug-analysis:
    if: >-
      github.event.label.name == 'type/bug' &&
      !contains(github.event.issue.labels.*.name, 'state/planned')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    concurrency:
      group: issue-plan-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Analyze bug
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --max-turns 15
            --allowedTools "Read,Grep,Glob,Bash(gh issue:*),Bash(gh label:*)"
          prompt: |
            You are a bug analysis assistant for the Infrahub VSCode Extension.

            Read the following project files to understand the codebase:
            - CLAUDE.md (project overview and coding standards)

            Then analyze this bug report:

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            Perform the analysis:

            1. **Locate the Code Path**: Trace from the reported behavior to the relevant
               source files. Identify which commands, providers, or handlers are involved.

            2. **Identify Root Cause**: Determine the most likely cause category:
               - API communication failure
               - YAML parsing error
               - VSCode API misuse
               - Configuration issue
               - Other

            3. **Recommended Fix**: Provide specific code changes with file paths and
               line-level guidance.

            4. **Regression Test**: Describe a test that would catch this bug.

            5. **Implementation Plan**: Ordered steps to fix this bug.

            Format your analysis with sections:
            ## Summary, ## Code Path, ## Root Cause, ## Recommended Fix, ## Regression Test, ## Implementation Plan

            After generating the analysis, post it as a comment on issue #${{ github.event.issue.number }}:
            Write the analysis to a temp file, then run:
            gh issue comment ${{ github.event.issue.number }} --body-file /tmp/analysis-comment.md

            The comment should be formatted as:
            ## Bug Analysis
            > Generated by Claude from bug report. Review before implementing.
            <your analysis>
            ---
            *To implement the fix, a maintainer can comment `@claude implement` on this issue.*

            Then update the labels:
            gh label create "state/planned" --force
            gh issue edit ${{ github.event.issue.number }} --add-label "state/planned"
            gh issue edit ${{ github.event.issue.number }} --remove-label "state/need-triage" || true
